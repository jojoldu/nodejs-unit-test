# 좋은 로깅 남기기

## 명확한 로깅 목표 세우기
다음 사항에 도움이 되는 로그 메시지를 작성한다.

- 시스템이 수행하는 작업을 추적합니다.
- 문제 발견 및 해결
- 보안 및 규칙 요구 사항 충족
- 시스템이 더 잘 작동하도록 만들기

## 모든 것을 기록하지 않기

## 로그 레벨 잘 설정하기

로그에 다양한 수준을 사용하면 로그를 체계적으로 정리하고 원하는 내용을 더 쉽게 찾을 수 있다. 

표준 로그 수준(디버그, 정보, 경고, 오류)을 따르는 것이 좋다. 혼란스러울 수 있으므로 직접 구성하지 않는 것이 바람직하다.

**DEBUG**

- **개발 혹은 테스트 단계**에서 해당 기능들이 올바르게 작동하는지 확인하기 위한 로그 레벨이다.  
  - 예를 들어 데이터베이스 연결이 생성되거나 해제되는 시점 혹은 함수 호출에 사용된 인자와 반환 값 등을 남겨서 개발 및 테스트 과정에서 문제를 추적하고 해결하는 데 도움을 주도록 한다.
- 요즘은 워낙 IDE의 디버거가 좋아져서 로컬 개발 단계에서는 활용할일이 적지만, Dev/QA 등 환경에서의 문제들을 파악해야할때 남기면 좋다.
  - 본인이 여전히 `console.log` 혹은 `System.out.println` 으로 로컬에서 문제를 확인한다면 **IDE의 디버거를 필수로 익히고**, 그게 당장은 어렵다면 `log.debug`로 로그를 남기는 것을 추천한다.
- 다른 레벨들과 달리 **운영 환경에서는 남기고 싶지 않은 로그 메세지**를 위한 레벨이다.

**INFO** 

- 애플리케이션에서 **정상 작동에 대한 정보** 즉, 어떤 일이 발생했음을 나타내는 표준 로그 레벨
- 애플리케이션 상태, 설정 또는 외부 리소스와의 상호 작용과 같은 상태 확인을 위한 이벤트를 나타낸다.   
  - 예를 들어, 인증 API의 백엔드 시스템에서 **인증이 성공했는지 여부에 따라 사용자가 인증을 요청한 정보**가 `INFO` 레벨의 로그로 남긴다.
  - 애플리케이션이 시작되거나 종료되는 시점, 중요한 작업이 완료되거나 실행되는 시점 (예: 배치 작업, 정기 작업) 등의 경우에도 남길 수 있다.
- `INFO` 로그는 **시스템을 파악하는데 유익한 정보**여야만 한다.
  - 무의미한 정보를 남길 필요가 없다.
- 운영 환경에서도 사용할 수 있다.

**WARN** 

- 애플리케이션에서 **잠재적으로 문제가 될 수 있는 상황**일때 남기는 로그 레벨
  - 예를 들어 사용자가 로그인에 실패하는 것은 ID, PW 등을 오입력하여 **언제든 발생할 수 있는 일반적인 문제 상황**이다.
    - 이럴때는 `WARN` 레벨로 책정하고, **로그인이 5번 연속 실패하는 등** 특정 기준치를 넘길 경우 `ERROR` 레벨로 남기는 것이 좋다.
  - 이와 유사하게 예상치 못한 입력 (사용자가 유효하지 않은 입력을 제공한 경우 - 예: 이메일 형식이 아닌 입력), 리소스 제한 (파일 업로드 사이즈 초과 등)과 같은 경고를 기록할 수 있다.
    - 이런 경우 **사용자에게 노출되는 메세지에 상세한 가이드가 필요한 것**이지, 로그 레벨이 ERROR일 필요가 없다.
- 이 레벨의 메세지는 개발자가 조치를 취할 수 있도록 주의를 기울일 필요가 있는 상황을 나타낸다.
- 운영 환경에서도 사용할 수 있다.

**ERROR** 

- 애플리케이션에서 발생한 **심각한 오류나 예외 상황**을 나타내는 로그 레벨
- 기능 자체가 제대로 작동하지 못하는 문제일때 남겨야 하며 **즉시 조치가 필요할때**를 의미한다.
  - 예를 들어 데이터베이스 연결이 실패한 경우, 내부 시스템의 문제로 결제가 실패하는 경우 등일 경우엔 `ERROR`로 남기며 즉시 조치를 취해야 한다. 
- 운영 환경에서도 사용할 수 있다.


좀 더 자세한 내용은 이전 글을 참고한다.

- [로그 레벨 구분하기](https://jojoldu.tistory.com/712)

## 로그 포맷 규칙 정하기

보통 다음과 같은 포맷을 사용한다.

```java
2022-07-27 14:30:00 ERROR [USER-123] User login failed: wrong password
```

- 발생 시기 
- 심각도 
- 영향을 받는 대상 
- 문제가 무엇인지

## 명확한 로그 메시지 작성하기


아래 내용이 포함되어야 한다.
- 오류 코드
- 이벤트 관련 중요정보
- 그 일이 일어난 시간
- 사용자 또는 시스템 ID
- 시스템이 무엇을 하고 있었는지

## 민감한 정보를 기록으로 남기지 않기



## 로거 잘 활용하기

### 로깅 프레임워크 사용하기

Exception을 기록으로 남기고 끝낼 경우에라도 로깅 프레임워크를 사용하는 편이 좋다.

```ts
// bad
try {
  // 비즈니스 로직
} catch (e) {
  console.error("fail to process file", e);
}
```

```ts
// good
try {
  // 비즈니스 로직
} catch (e) {
  logger.error("fail to process file", e);
}
```


JVM의 `e.printStackTrace()`, Node.js의 `console.log | console.error` 등은 콘솔로만 메세지를 남긴다.  
물론 `e.printStackTrace()` 은 Tomcat을 사용할 경우 `{TOMCAT_HOME}/logs/catalina.out` 에 남긴 하지만, 이는 기본적인 로깅 프레임워크들처럼 로그 데이터에 대한 세부적인 설정을 할 수가 없다.  
  
이와 같이 콘솔 메세지로 관리하는 것에는 크게 2가지 문제가 있다.

- 적절한 로그레벨을 사용할 수 없다.
- 다양한 로그 형태를 사용할 수 없다.


로깅 프레임워크를 이용하면 파일을 쪼개는 정책을 설정할 수 있고, 여러 서버의 로그를 한곳에서 모아서 보는 시스템을 활요할 수도 있다. 

## logger에서는 전체 에러 스택을 남긴다.

로거 메소드에 Exception객체를 직접 넘기면 `e.printStackTrace()` 처럼 Exception의 스택도 모두 남겨준다. 
에러의 추적성을 높이기 위해서는 `e.toString()` 이나 `e.getMessage()` 로 마지막 메시지만 남기기보다는 전체 에러 스택을 다 넘기는 편이 좋다.

```ts
// bad
try {
  // 비즈니스 로직
} catch (e) {
  logger.error(`fail to process file: ${e.getMessage()}`);
}
```

```ts
// good
try {
  // 비즈니스 로직
} catch (e) {
  logger.error("fail to process file", e);
}
```


## 계속해서 점검하고 개선하기

