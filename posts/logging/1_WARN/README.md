# 1. 효율적으로 로그 모니터링하기 - 로그 레벨 구분하기

365/24 로 관리하는 시스템에서 로그는 굉장히 중요하다.  
하지만 로그가 중요하다는 생각에 무분별하게 남기는 것은 좋지 않다.
대표적인 예로 습관적으로 **예외 상황이 발생하면 ERROR 레벨로 로그**를 남기는 경우이다.  
  
보통의 서비스에서는 **시간 내 에러 로그가 일정 수치 이상 쌓이면 알람**을 발생시키도록 구성한다.  
정상적이지 않은 모든 상황에서 전부 ERROR 레벨로 처리하게 되면 불필요하게 많은 알람들로 인해 **정작 봐야할 심각한 에러 로그들도 놓칠 수 있다**.  
  
그래서 적정 수준에서 **로그 레벨을 구분하여 알람 경보 수준도 구분**하는 것이 필요하다.

## 로그 레벨

로그 레벨은 해당 로그 메세지가 얼마나 중요한지를 알려주는 정보이다.  
로그 레벨의 중요도는 담당 개발자가 밤에 계속 잠을 잘 수 있는지, 즉시 침대에서 일어나 노트북을 켜야하는지를 구분할 수 있게 해준다.
  
로그 수준은 시스템 상태에 대한 중요한 정보와 순전히 유익한 정보를 필터링하는 방법으로 생각할 수 있다.  
로그 수준은 정보 노이즈 및 경고 피로를 줄이는 데 도움이 될 수 있다.

로깅 프레임워크들마다 지원하는 로그 레벨들이 조금씩 다르지만, 공통적으로 가지고 있는 레벨은 다음과 같다.

**DEBUG**

- **개발 혹은 테스트 단계**에서 해당 기능들이 올바르게 작동하는지 확인하기 위한 로그 레벨이다.  
  - 예를 들어 데이터베이스 연결이 생성되거나 해제되는 시점 혹은 함수 호출에 사용된 인자와 반환 값 등을 남겨서 개발 및 테스트 과정에서 문제를 추적하고 해결하는 데 도움을 주도록 한다.
- 요즘은 워낙 IDE의 디버거가 좋아져서 로컬 개발 단계에서는 활용할일이 적지만, Dev/QA 등 환경에서의 문제들을 파악해야할때 남기면 좋다.
  - 본인이 여전히 `console.log` 혹은 `System.out.println` 으로 로컬에서 문제를 확인한다면 **IDE의 디버거를 필수로 익히고**, 그게 당장은 어렵다면 `log.debug`로 로그를 남기는 것을 추천한다.
- 다른 레벨들과 달리 **운영 환경에서는 남기고 싶지 않은 로그 메세지**를 위한 레벨이다.

**INFO** 

- 애플리케이션에서 **정상 작동에 대한 정보** 즉, 어떤 일이 발생했음을 나타내는 표준 로그 레벨
- 애플리케이션 상태, 설정 또는 외부 리소스와의 상호 작용과 같은 상태 확인을 위한 이벤트를 나타낸다.   
  - 예를 들어, 인증 API의 백엔드 시스템에서 **인증이 성공했는지 여부에 따라 사용자가 인증을 요청한 정보**가 `INFO` 레벨의 로그로 남긴다.
  - 애플리케이션이 시작되거나 종료되는 시점, 중요한 작업이 완료되거나 실행되는 시점 (예: 배치 작업, 정기 작업) 등의 경우에도 남길 수 있다.
- `INFO` 로그는 **시스템을 파악하는데 유익한 정보**여야만 한다.
  - 무의미한 정보를 남길 필요가 없다.
- 운영 환경에서도 사용할 수 있다.

**WARN** 

- 애플리케이션에서 **잠재적으로 문제가 될 수 있는 상황**일때 남기는 로그 레벨
  - 예를 들어 사용자가 로그인에 실패하는 것은 ID, PW 등을 오입력하여 **언제든 발생할 수 있는 일반적인 문제 상황**이다.
    - 이럴때는 `WARN` 레벨로 책정하고, **로그인이 5번 연속 실패하는 등** 특정 기준치를 넘길 경우 `ERROR` 레벨로 남기는 것이 좋다.
  - 이와 유사하게 예상치 못한 입력 (사용자가 유효하지 않은 입력을 제공한 경우 - 예: 이메일 형식이 아닌 입력), 리소스 제한 (파일 업로드 사이즈 초과 등)과 같은 경고를 기록할 수 있다.
    - 이런 경우 **사용자에게 노출되는 메세지에 상세한 가이드가 필요한 것**이지, 로그 레벨이 ERROR일 필요가 없다.
- 이 레벨의 메세지는 개발자가 조치를 취할 수 있도록 주의를 기울일 필요가 있는 상황을 나타낸다.
- 운영 환경에서도 사용할 수 있다.

**ERROR** 

- 애플리케이션에서 발생한 **오류나 예외 상황**을 나타내는 로그 레벨
- 기능 자체가 제대로 작동하지 못하는 문제일때 남겨야 하며 **즉시 조치가 필요할때**를 의미한다.
  - 예를 들어 데이터베이스 연결이 실패한 경우, 내부 시스템의 문제로 결제가 실패하는 경우 등일 경우엔 `ERROR`로 남기며 즉시 조치를 취해야 한다. 
- 운영 환경에서도 사용할 수 있다.

각 로그 레벨에 맞게 로그를 남긴다면 
이 중에서 운영에서 필요한 것은 **WARN 레벨과 ERROR 레벨을 구분**하는 것이다.

## 수시로 발생할 수 있는 문제들 - WARN
### 외부 API 연동

사내 서비스가 아닌 외부 API 서비스의 호출을 100% 성공하도록 관리하는 것은 불가능하다.  
따라서 **외부 API 호출의 일정 비율이 실패하는 것이 일상**인 것을 어느정도 전제해야 한다.  

예를 들어 다음과 같이 API 연동이 있다고 가정해보자.

```ts
function get(url): string {
    try {
        return api.getCompanyInfo (url);
    } catch (Exception e) {
        log.error("Error occurred", e);
        return "A default response";
    }
}
```

분당 1만건의 트래픽이 발생하는 API라면 대략 외부 API의 실패율이 `0.1%` (성공율 `99.9%`) 만 되어도 분당 10개의 `ERROR` 로그가 발생한다.  
분당 10개의 `ERROR` 로그는 일반적인 시스템에서는 **모니터링 알람이 발생할 수 있는 수치**이다.  
  
따라서 각각을 오류로 기록하면 생산 로그에 대량의 노이즈가 생성된다.

```ts
function get(url): string {
    try {
        return api.getCompanyInfo (url);
    } catch (Exception e) {
        log.warn("Error occurred", e);
        return "A default response";
    }
}
```

`ERROR`로 기록하는 것보다 `WARN` 으로 기록하는 것이 좋다.

예외적으로 외부 API이지만 `ERROR` 레벨로 관리해야 하는 경우는 아래정도로 생각한다.

- 현재 트래픽 자체가 높지 않은 경우
  - 연동한 API가 하루 1%의 에러율을 가진다 하더라도 우리 트래픽이 낮아 하나하나의 요청 실패가 중요한 경우엔 그냥 다 ERROR로 처리한다.
- 결제와 같이 한번 실패시 치명적인 영향을 끼치는 서비스인 경우
  - 특히 별도로 [정산 대사](https://docs.tosspayments.com/guides/apis/settlements#%EC%A0%95%EC%82%B0-%EC%A1%B0%ED%9A%8C%ED%95%98%EA%B8%B0)를 시스템화 하지 않았다면 더더욱 중요하다. 
- 하루 1번, 한달에 1번 정도로 요청 자체가 주기적으로 적은 횟수만 수행하는 경우  


### 사용자의 입력


## 마무리

로그 레벨 중 `WARN`과 `ERROR`을 구분하면 진짜 봐야할 중요한 문제들만 볼 수 있다.  
둘의 레벨을 구분하면 아래와 같이 모니터링 기준을 가져갈 수 있다.

- `WARN`: 분당 20개이상일 경우 알람
- `ERROR`: 분당 5개이상일 경우 알람



